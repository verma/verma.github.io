<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Datascript 101 - Chapter 2 | Uday Verma's Blog</title><meta name=keywords content><meta name=description content="Learn how to setup uniqueness and identity."><meta name=author content><link rel=canonical href=https://udayv.com/blog/2016-05-06-datascript101-chapter2-uniqueness-and-indexing/><link href=/assets/css/stylesheet.min.3dac925eb9bf5bf78d5d4e966755e4f4ae8ca86c5a9a3d1dcff2aaef78333302.css integrity="sha256-PaySXrm/W/eNXU6WZ1Xk9K6MqGxamj0dz/Kq73gzMwI=" rel="preload stylesheet" as=style><link rel=icon href=https://udayv.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://udayv.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://udayv.com/favicon-32x32.png><link rel=apple-touch-icon href=https://udayv.com/apple-touch-icon.png><link rel=mask-icon href=https://udayv.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><meta property="og:title" content="Datascript 101 - Chapter 2"><meta property="og:description" content="Learn how to setup uniqueness and identity."><meta property="og:type" content="article"><meta property="og:url" content="https://udayv.com/blog/2016-05-06-datascript101-chapter2-uniqueness-and-indexing/"><meta property="article:published_time" content="2016-05-06T00:00:00+00:00"><meta property="article:modified_time" content="2016-05-06T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Datascript 101 - Chapter 2"><meta name=twitter:description content="Learn how to setup uniqueness and identity."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://udayv.com/blog/"},{"@type":"ListItem","position":2,"name":"Datascript 101 - Chapter 2","item":"https://udayv.com/blog/2016-05-06-datascript101-chapter2-uniqueness-and-indexing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Datascript 101 - Chapter 2","name":"Datascript 101 - Chapter 2","description":"Learn how to setup uniqueness and identity.","keywords":[],"articleBody":"This is part 2 of 3 part series on Datascript. I suggest that you skim over Part 1 before reading this.\nRandom quote from Dune:\n “It is so shocking to find out how many people do not believe that they can learn, and how many more believe learning to be difficult.” ― Frank Herbert, Dune\n We will try to setup some identities and make our lives easier a bit.\nLets do this!\n(def schema {:car/model {:db/unique :db.unique/identity} :car/maker {:db/type :db.type/ref} :car/colors {:db/cardinality :db.cardinality/many}} See that :car/model definition. You’re saying:\n “Hey this :car/model field is going to be unique and will be used to identify this entity (a car in this case).”\n These entity “identifiers” can be your domain specific things (so you don’t have to always rely on Datascript’s ID stuff), things like order numbers, email addresses etc.\nLets define an “identifier” (or an identity) for our makers as well.\n(def schema {:maker/email {:db/unique :db.unique/identity} :car/model {:db/unique :db.unique/identity} :car/maker {:db/type :db.type/ref} :car/colors {:db/cardinality :db.cardinality/many}} (def conn (d/create-conn schema}) We’ll be identifying our makers by their email addresses.\nLevel 3 - Insertion Lets insert a new maker and a car along with it.\n(d/transact! conn [{:maker/email \"ceo@bmw.com\" :maker/name \"BMW\"} {:car/model \"E39530i\" :car/maker [:maker/email \"ceo@bmw.com\"] :car/name \"2003 530i\"}]) Some things to notice:\n We’re inserting a maker and a car together (like we did in our last chapter). We’re not using -1 to explicitly assign a temporary ID to our maker to be able to refer to it when adding our car (like we did in our last chapter). We’re using something called a “plz lookup a ref for me” (also know as “lookup-refs”) to identify our maker and then refer to it, that [:maker/email \"ceo@bmw.com\"] is a lookup ref. So we don’t have to deal with -1 etc. or Datascript generated entity IDS.  Note that Datascript will still generate a :db/id for us behind the scenes, but for all intents and purposes for now, you can use lookup-refs instead of entities wherever they’re needed.\nAll of this is fine and dandy, but what can I do with it other than easy insertions?\nLevel 2 - Querying Concise entity lookups\n(d/entity @conn [:car/model \"E39530i\"]) = {:db/id 2} (d/entity @conn [:maker/email \"ceo@bmw.com\"]) = {:db/id 1} In our last chapter, we had to write a pretty elaborate query to get the entity ID which we could pass to d/entity. Now we can use a lookup-ref to fetch the same thing.\nNote that, d/entity returns a “lazy” entity. When you fetch a certain attribute out of it, it will be resolved for you.\n(:maker/name (d/entity @conn [:maker/email \"ceo@bmw.com\"])) = \"BMW\" Level 4 - Insertion We want to insert a new car now, and need the ref of our maker to insert it. Because of lookup refs we don’t have explictely query entity IDs:\n(d/transact! conn [{:car/model \"E39520i\" :car/maker [:maker/email \"ceo@bmw.com\"] :car/name \"2003 520i\"}]) WIN! We just used a lookup-ref to specify the maker!\nLevel 3 - Querying Can we use these lookup-refs when querying stuff? Lets find all cars made by BWM.\n(d/q '[:find [?name ...] :where [?c :car/maker [:maker/email \"ceo@bmw.com\"]] [?c :car/name ?name]] @conn) = [\"2003 530i\" \"2003 520i\"] Yay! See that [?name ...] unholy-ness right after :find? I will tackle that in my next chapter!\nLevel 5 - Insertion ACHIVEMENT UNLOCKED! You’re still here!\nWhat if BMW CEO decides that the name “BWM” needs to be changed to “BWM Motors”. How can we go and update the name? Lookup-refs make your life easier here as well:\n(d/transact! conn [{:maker/email \"ceo@bmw.com\" :maker/name \"BMW Motors\"]) You’re basically re-inserting a maker with a new name but the email is the same as the one we already have, it will be taken care of for you.\n(:maker/name (d/entity @conn [:maker/email \"ceo@bmw.com\"])) = \"BMW Motors\" Takeaways Here are some things to take away from this chapter:\n Lookup-refs are interchangeable with entity IDs almost everywhere, Datascript will complain when they’re not, so go ahead and use them liberally. Use identity and uniqueness to model your domain specific “identifiers”.  Things to try  Insert some more makers and cars. Try adding some more attributes and identities to the schema and try and use them.  All of the stuff here is available as a gist here{:target=\"_blank\"}.\nI will see you next time!\n","wordCount":"709","inLanguage":"en","datePublished":"2016-05-06T00:00:00Z","dateModified":"2016-05-06T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://udayv.com/blog/2016-05-06-datascript101-chapter2-uniqueness-and-indexing/"},"publisher":{"@type":"Organization","name":"Uday Verma's Blog","logo":{"@type":"ImageObject","url":"https://udayv.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://udayv.com/ accesskey=h title="Uday Verma's Blog (Alt + H)">Uday Verma's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Datascript 101 - Chapter 2</h1><section class=entry-tags><p>clojurescript</p><p>clojure</p></section><div class=post-meta>May 6, 2016&nbsp;·&nbsp;4 min</div></header><div class=post-content><p>This is part 2 of 3 part series on Datascript. I suggest that you skim over <a href=https://udayv.com/blog/2016-04-28-datascript101-chapter1-initializing-inserting-and-querying-records/>Part 1</a> before reading this.</p><p>Random quote from Dune:</p><blockquote><p>“It is so shocking to find out how many people do not believe that they can learn, and how many more believe learning to be difficult.” ― Frank Herbert, Dune</p></blockquote><p>We will try to setup some identities and make our lives easier a bit.</p><p>Lets do this!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#66d9ef>def </span>schema {<span style=color:#e6db74>:car/model</span> {<span style=color:#e6db74>:db/unique</span> <span style=color:#e6db74>:db.unique/identity</span>}
             <span style=color:#e6db74>:car/maker</span> {<span style=color:#e6db74>:db/type</span> <span style=color:#e6db74>:db.type/ref</span>}
             <span style=color:#e6db74>:car/colors</span> {<span style=color:#e6db74>:db/cardinality</span> <span style=color:#e6db74>:db.cardinality/many</span>}}</code></pre></div><p>See that <code>:car/model</code> definition. You&rsquo;re saying:</p><blockquote><p>&ldquo;Hey this :car/model field is going to be unique and will be used to identify this entity (a car in this case).&rdquo;</p></blockquote><p>These entity &ldquo;identifiers&rdquo; can be your domain specific things (so you don&rsquo;t have to always rely on Datascript&rsquo;s ID stuff), things like order numbers, email addresses etc.</p><p>Lets define an &ldquo;identifier&rdquo; (or an identity) for our makers as well.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#66d9ef>def </span>schema {<span style=color:#e6db74>:maker/email</span> {<span style=color:#e6db74>:db/unique</span> <span style=color:#e6db74>:db.unique/identity</span>}

             <span style=color:#e6db74>:car/model</span> {<span style=color:#e6db74>:db/unique</span> <span style=color:#e6db74>:db.unique/identity</span>}
             <span style=color:#e6db74>:car/maker</span> {<span style=color:#e6db74>:db/type</span> <span style=color:#e6db74>:db.type/ref</span>}
             <span style=color:#e6db74>:car/colors</span> {<span style=color:#e6db74>:db/cardinality</span> <span style=color:#e6db74>:db.cardinality/many</span>}}

(<span style=color:#66d9ef>def </span>conn (<span style=color:#a6e22e>d/create-conn</span> schema})</code></pre></div><p>We&rsquo;ll be identifying our makers by their email addresses.</p><h2 id=level-3---insertion>Level 3 - Insertion<a hidden class=anchor aria-hidden=true href=#level-3---insertion>#</a></h2><p>Lets insert a new maker and a car along with it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/transact!</span> conn [{<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>
                    <span style=color:#e6db74>:maker/name</span> <span style=color:#e6db74>&#34;BMW&#34;</span>}
                   {<span style=color:#e6db74>:car/model</span> <span style=color:#e6db74>&#34;E39530i&#34;</span>
                    <span style=color:#e6db74>:car/maker</span> [<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>]
                    <span style=color:#e6db74>:car/name</span> <span style=color:#e6db74>&#34;2003 530i&#34;</span>}])</code></pre></div><p>Some things to notice:</p><ul><li>We&rsquo;re inserting a maker and a car together (like we did in our last chapter).</li><li>We&rsquo;re not using <code>-1</code> to explicitly assign a temporary ID to our maker to be able to refer to it when adding our car (like we did in our last chapter).</li><li>We&rsquo;re using something called a &ldquo;plz lookup a ref for me&rdquo; (also know as &ldquo;lookup-refs&rdquo;) to identify our maker and then refer to it, that <code>[:maker/email "ceo@bmw.com"]</code> is a lookup ref. So we don&rsquo;t have to deal with <code>-1</code> etc. or Datascript generated entity IDS.</li></ul><p>Note that Datascript will still generate a <code>:db/id</code> for us behind the scenes, but for all intents and purposes for now, you can use lookup-refs instead of entities wherever they&rsquo;re needed.</p><p>All of this is fine and dandy, but what can I do with it other than easy insertions?</p><h2 id=level-2---querying>Level 2 - Querying<a hidden class=anchor aria-hidden=true href=#level-2---querying>#</a></h2><p>Concise entity lookups</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/entity</span> <span style=color:#f92672>@</span>conn [<span style=color:#e6db74>:car/model</span> <span style=color:#e6db74>&#34;E39530i&#34;</span>])
=&gt; {<span style=color:#e6db74>:db/id</span> <span style=color:#ae81ff>2</span>}

(<span style=color:#a6e22e>d/entity</span> <span style=color:#f92672>@</span>conn [<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>])
=&gt; {<span style=color:#e6db74>:db/id</span> <span style=color:#ae81ff>1</span>}</code></pre></div><p>In our last chapter, we had to write a pretty elaborate query to get the entity ID which we could pass to <code>d/entity</code>. Now we can use a lookup-ref to fetch the same thing.</p><p>Note that, <code>d/entity</code> returns a &ldquo;lazy&rdquo; entity. When you fetch a certain attribute out of it, it will be resolved for you.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#e6db74>:maker/name</span> (<span style=color:#a6e22e>d/entity</span> <span style=color:#f92672>@</span>conn [<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>]))
=&gt; <span style=color:#e6db74>&#34;BMW&#34;</span></code></pre></div><h2 id=level-4---insertion>Level 4 - Insertion<a hidden class=anchor aria-hidden=true href=#level-4---insertion>#</a></h2><p>We want to insert a new car now, and need the ref of our maker to insert it. Because of lookup refs we don&rsquo;t have explictely query entity IDs:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/transact!</span> conn [{<span style=color:#e6db74>:car/model</span> <span style=color:#e6db74>&#34;E39520i&#34;</span>
                    <span style=color:#e6db74>:car/maker</span> [<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>]
                    <span style=color:#e6db74>:car/name</span> <span style=color:#e6db74>&#34;2003 520i&#34;</span>}])</code></pre></div><p>WIN! We just used a lookup-ref to specify the maker!</p><h2 id=level-3---querying>Level 3 - Querying<a hidden class=anchor aria-hidden=true href=#level-3---querying>#</a></h2><p>Can we use these lookup-refs when querying stuff? Lets find all cars made by BWM.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/q</span> <span style=color:#f92672>&#39;</span>[<span style=color:#e6db74>:find</span> [?name ...]
       <span style=color:#e6db74>:where</span>
       [?c <span style=color:#e6db74>:car/maker</span> [<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>]]
       [?c <span style=color:#e6db74>:car/name</span> ?name]]
     <span style=color:#f92672>@</span>conn)
=&gt; [<span style=color:#e6db74>&#34;2003 530i&#34;</span> <span style=color:#e6db74>&#34;2003 520i&#34;</span>]</code></pre></div><p>Yay! See that <code>[?name ...]</code> unholy-ness right after <code>:find</code>? I will tackle that in my next chapter!</p><h2 id=level-5---insertion>Level 5 - Insertion<a hidden class=anchor aria-hidden=true href=#level-5---insertion>#</a></h2><p>ACHIVEMENT UNLOCKED! You&rsquo;re still here!</p><p>What if BMW CEO decides that the name &ldquo;BWM&rdquo; needs to be changed to &ldquo;BWM Motors&rdquo;. How can we go and update the name? Lookup-refs make your life easier here as well:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/transact!</span> conn [{<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>
                    <span style=color:#e6db74>:maker/name</span> <span style=color:#e6db74>&#34;BMW Motors&#34;</span>])</code></pre></div><p>You&rsquo;re basically re-inserting a maker with a new name but the email is the same as the one we already have, it will be taken care of for you.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#e6db74>:maker/name</span> (<span style=color:#a6e22e>d/entity</span> <span style=color:#f92672>@</span>conn [<span style=color:#e6db74>:maker/email</span> <span style=color:#e6db74>&#34;ceo@bmw.com&#34;</span>]))
=&gt; <span style=color:#e6db74>&#34;BMW Motors&#34;</span></code></pre></div><h2 id=takeaways>Takeaways<a hidden class=anchor aria-hidden=true href=#takeaways>#</a></h2><p>Here are some things to take away from this chapter:</p><ul><li>Lookup-refs are interchangeable with entity IDs almost everywhere, Datascript will complain when they&rsquo;re not, so go ahead and use them liberally.</li><li>Use identity and uniqueness to model your domain specific &ldquo;identifiers&rdquo;.</li></ul><h2 id=things-to-try>Things to try<a hidden class=anchor aria-hidden=true href=#things-to-try>#</a></h2><ul><li>Insert some more makers and cars.</li><li>Try adding some more attributes and identities to the schema and try and use them.</li></ul><p>All of the stuff here is available <a href=https://gist.github.com/verma/754521e85d9ddbc6554df13b82e3e255>as a gist here</a>{:target="_blank"}.</p><p>I will see you next time!</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://udayv.com/>Uday Verma's Blog</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>