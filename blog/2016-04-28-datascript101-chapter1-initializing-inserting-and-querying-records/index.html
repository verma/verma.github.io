<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Datascript 101 - Chapter 1 | Uday Verma's Blog</title><meta name=keywords content><meta name=description content="Learn how to initialize Datascript and Insert and Query some records."><meta name=author content><link rel=canonical href=https://udayv.com/blog/2016-04-28-datascript101-chapter1-initializing-inserting-and-querying-records/><link href=/assets/css/stylesheet.min.3dac925eb9bf5bf78d5d4e966755e4f4ae8ca86c5a9a3d1dcff2aaef78333302.css integrity="sha256-PaySXrm/W/eNXU6WZ1Xk9K6MqGxamj0dz/Kq73gzMwI=" rel="preload stylesheet" as=style><link rel=icon href=https://udayv.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://udayv.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://udayv.com/favicon-32x32.png><link rel=apple-touch-icon href=https://udayv.com/apple-touch-icon.png><link rel=mask-icon href=https://udayv.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><meta property="og:title" content="Datascript 101 - Chapter 1"><meta property="og:description" content="Learn how to initialize Datascript and Insert and Query some records."><meta property="og:type" content="article"><meta property="og:url" content="https://udayv.com/blog/2016-04-28-datascript101-chapter1-initializing-inserting-and-querying-records/"><meta property="article:published_time" content="2016-04-28T18:00:00+00:00"><meta property="article:modified_time" content="2016-04-28T18:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Datascript 101 - Chapter 1"><meta name=twitter:description content="Learn how to initialize Datascript and Insert and Query some records."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://udayv.com/blog/"},{"@type":"ListItem","position":2,"name":"Datascript 101 - Chapter 1","item":"https://udayv.com/blog/2016-04-28-datascript101-chapter1-initializing-inserting-and-querying-records/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Datascript 101 - Chapter 1","name":"Datascript 101 - Chapter 1","description":"Learn how to initialize Datascript and Insert and Query some records.","keywords":[],"articleBody":"Let’s begin our journey into Datascript. We’ll start with very basic stuff.\nAssuming that you have Datascript :required in as d, initialize a database:\n(def conn (d/create-conn {}) The {} is the schema where you define how certain attributes (think fields) behave: “Are they references?”, “Are they arrays?” etc.\n(def schema {:car/maker {:db/type :db.type/ref} :car/colors {:db/cardinality :db.cardinality/many}} (def conn (d/create-conn schema}) Now we have a database conn with some schema, we’re saying:\n “I will have a :car/maker attribute which will be a reference to some other entity (think record), so do the needful when I ask you to handle it (e.g. de-refing). Also, :car/colors is going to be an array.”\n Basically, to simplify a bit, you can think of schema as hints to Datascript to help make our lives easier.\nNow, lets insert some schnitzel:\nLevel 1 - Insertion (d/transact! conn [{:maker/name \"Honda\" :maker/country \"Japan\"}] What’s going on here?\n transact! means we’re going to transact something (insert/delete/update). conn is our database (or database connection if you will). The weird looking array is what we intend to transact. There are several ways this can be specified as we’ll learn in future lessons. Here we are simply asking Datascript to insert these two “attributes” about “some entity” into the database.  As you can see, I didn’t add any of the attributes I mentioned in my schema, you only need to define stuff that you want to specifically control. Lets do one more.\nLevel 2 - Insertion (d/transact! conn [{:db/id -1 :maker/name \"BMW\" :maker/country \"Germany\"} {:car/maker -1 :car/name \"i525\" :car/colors [\"red\" \"green\" \"blue\"]}]) What in the …?\nThe new things here:\n We’re transacting multiple things (since the array now has two maps). There’s a weird :db/id field set to -1 in our maker insertion. There’s a :car/maker attribute set to -1 in our car insertion. The :cars/colors attribute is an array, it will be handled correctly for us because we mentioned that in the schema, it has many wow cardinaleeteez.  You’re saying:\n “Insert two things: a maker and a car made by that maker. Give the maker an id -1 (because I am going to refer to it later), then add a car and set the car’s maker ref as the maker I just inserted (identified by -1).”\n I wonder if it still works if I switch the insertion order around.\nThe -1 is resolved to a real entity id when the transaction happens and the :car/maker is correctly set to it. The -1 here is just a temporary id for us to connect stuff up as we insert it, without us having to do multiple transactions (insert maker first, get id, then insert car).\nLevel 1 - Querying Now to fetch these values out of the database:\n(d/q '[:find ?name :where [?e :maker/name \"BMW\"] [?c :car/maker ?e] [?c :car/name ?name]] @conn) This should give you #{[\"i525\"]}.\nThat looks like an awful way to do whatever the heck its doing. Fear not, fear is the mind-killer.\nI don’t want to go into how datascript stores stuff internally as datoms and all the stuff that goes on (since I don’t completely understand it yet). For now lets’s keep it simple:\n Anything that starts with ? is a variable which will hold a value for us as we process the :where rules. The thing after :find is what the query will return. In this case whatever ends up being in ?name comes out. Each :where rule has a specific format, for our purposes for now its: [  ]. A variable in a rule is assigned any values that satisfies that rule. E.g. when we say [?m :maker/name \"BMW\"] the variable ?m is at the  position, so once this rule is processed, ?m holds the entity-id for “BMW” maker.  So as we go down the rules:\n [?m :maker/name \"BMW\"] - ?m ends up the entity-id of the “BMW” maker. [?c :car/maker ?m] - ?c ends up with the entity-id of the car which has its maker as ?m (which is “BMW”). [?c :car/name ?name] - ?name ends up with the value of the :car/name attribute of the ?c entity-id, which in this case is\"i525\". The rule processing finishes and we endup with \"i525\" in ?name which is finally returned from the query.  You could have also done this: (let [car-entity (ffirst (d/q '[:find ?c :where [?e :maker/name \"BMW\"] [?c :car/maker ?e]] @conn))] (:car/name (d/entity @conn car-entity)))\nAs far as I know there are better ways of doing things that I (and may be ?you) will eventually learn about.\nThings to try  Insert some more cars and makers. What do you get from our query when a maker has multiple cars?  Things to think about  How do I get an entity-id if I want to insert a car later down the line and I’ve already inserted the maker? In other words, how do I insert a car which is made by “Honda”? For now may be make two queries? First to get the entity-id for “Honda” followed by a transact to do the insertion?  All of the stuff here is available as a gist here{:target=\"_blank\"}.\nI will see you next time.\n","wordCount":"856","inLanguage":"en","datePublished":"2016-04-28T18:00:00Z","dateModified":"2016-04-28T18:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://udayv.com/blog/2016-04-28-datascript101-chapter1-initializing-inserting-and-querying-records/"},"publisher":{"@type":"Organization","name":"Uday Verma's Blog","logo":{"@type":"ImageObject","url":"https://udayv.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://udayv.com/ accesskey=h title="Uday Verma's Blog (Alt + H)">Uday Verma's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Datascript 101 - Chapter 1</h1><section class=entry-tags><p>clojurescript</p><p>clojure</p></section><div class=post-meta>April 28, 2016&nbsp;·&nbsp;5 min</div></header><div class=post-content><p>Let&rsquo;s begin our journey into Datascript. We&rsquo;ll start with very basic stuff.</p><p>Assuming that you have Datascript <code>:require</code>d in as <code>d</code>, initialize a database:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#66d9ef>def </span>conn (<span style=color:#a6e22e>d/create-conn</span> {})</code></pre></div><p>The <code>{}</code> is the schema where you define how certain attributes (think fields) behave: &ldquo;Are they references?&rdquo;, &ldquo;Are they arrays?&rdquo; etc.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#66d9ef>def </span>schema {<span style=color:#e6db74>:car/maker</span> {<span style=color:#e6db74>:db/type</span> <span style=color:#e6db74>:db.type/ref</span>}
             <span style=color:#e6db74>:car/colors</span> {<span style=color:#e6db74>:db/cardinality</span> <span style=color:#e6db74>:db.cardinality/many</span>}}

(<span style=color:#66d9ef>def </span>conn (<span style=color:#a6e22e>d/create-conn</span> schema})</code></pre></div><p>Now we have a database <code>conn</code> with some schema, we&rsquo;re saying:</p><blockquote><p>&ldquo;I will have a <code>:car/maker</code> attribute which will be a reference to some other entity (think record), so do the needful when I ask you to handle it (e.g. de-refing). Also, <code>:car/colors</code> is going to be an array.&rdquo;</p></blockquote><p>Basically, to simplify a bit, you can think of schema as hints to Datascript to help make our lives easier.</p><p>Now, lets insert some schnitzel:</p><h2 id=level-1---insertion>Level 1 - Insertion<a hidden class=anchor aria-hidden=true href=#level-1---insertion>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/transact!</span> conn [{<span style=color:#e6db74>:maker/name</span> <span style=color:#e6db74>&#34;Honda&#34;</span>
                    <span style=color:#e6db74>:maker/country</span> <span style=color:#e6db74>&#34;Japan&#34;</span>}]</code></pre></div><p>What&rsquo;s going on here?</p><ul><li><code>transact!</code> means we&rsquo;re going to transact something (insert/delete/update).</li><li><code>conn</code> is our database (or database connection if you will).</li><li>The weird looking array is what we intend to transact. There are several ways this can be specified as we&rsquo;ll learn in future lessons. Here we are simply asking Datascript to insert these two &ldquo;attributes&rdquo; about &ldquo;some entity&rdquo; into the database.</li></ul><p>As you can see, I didn&rsquo;t add any of the attributes I mentioned in my schema, you only need to define stuff that you want to specifically control. Lets do one more.</p><h2 id=level-2---insertion>Level 2 - Insertion<a hidden class=anchor aria-hidden=true href=#level-2---insertion>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/transact!</span> conn [{<span style=color:#e6db74>:db/id</span> <span style=color:#ae81ff>-1</span>
                    <span style=color:#e6db74>:maker/name</span> <span style=color:#e6db74>&#34;BMW&#34;</span>
                    <span style=color:#e6db74>:maker/country</span> <span style=color:#e6db74>&#34;Germany&#34;</span>}
                   {<span style=color:#e6db74>:car/maker</span> <span style=color:#ae81ff>-1</span>
                    <span style=color:#e6db74>:car/name</span> <span style=color:#e6db74>&#34;i525&#34;</span>
                    <span style=color:#e6db74>:car/colors</span> [<span style=color:#e6db74>&#34;red&#34;</span> <span style=color:#e6db74>&#34;green&#34;</span> <span style=color:#e6db74>&#34;blue&#34;</span>]}])</code></pre></div><p>What in the &mldr;?</p><p>The new things here:</p><ul><li>We&rsquo;re transacting multiple things (since the array now has two maps).</li><li>There&rsquo;s a weird <code>:db/id</code> field set to -1 in our maker insertion.</li><li>There&rsquo;s a <code>:car/maker</code> attribute set to -1 in our car insertion.</li><li>The <code>:cars/colors</code> attribute is an array, it will be handled correctly for us because we mentioned that in the schema, it has many wow cardinaleeteez.</li></ul><p>You&rsquo;re saying:</p><blockquote><p>&ldquo;Insert two things: a maker and a car made by that maker. Give the maker an id -1 (because I am going to refer to it later), then add a car and set the car&rsquo;s maker ref as the maker I just inserted (identified by -1).&rdquo;</p></blockquote><p>I wonder if it still works if I switch the insertion order around.</p><p>The -1 is resolved to a real entity id when the transaction happens and the <code>:car/maker</code> is correctly set to it. The -1 here is just a temporary id for us to connect stuff up as we insert it, without us having to do multiple transactions (insert maker first, get id, then insert car).</p><h2 id=level-1---querying>Level 1 - Querying<a hidden class=anchor aria-hidden=true href=#level-1---querying>#</a></h2><p>Now to fetch these values out of the database:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#a6e22e>d/q</span> <span style=color:#f92672>&#39;</span>[<span style=color:#e6db74>:find</span> ?name
       <span style=color:#e6db74>:where</span>
       [?e <span style=color:#e6db74>:maker/name</span> <span style=color:#e6db74>&#34;BMW&#34;</span>]
       [?c <span style=color:#e6db74>:car/maker</span> ?e]
       [?c <span style=color:#e6db74>:car/name</span> ?name]]
     <span style=color:#f92672>@</span>conn)</code></pre></div><p>This should give you <code>#{["i525"]}</code>.</p><p>That looks like an awful way to do whatever the heck its doing. Fear not, fear is the mind-killer.</p><p>I don&rsquo;t want to go into how datascript stores stuff internally as datoms and all the stuff that goes on (since I don&rsquo;t completely understand it yet). For now lets&rsquo;s keep it simple:</p><ul><li>Anything that starts with <code>?</code> is a variable which will hold a value for us as we process the <code>:where</code> rules.</li><li>The thing after <code>:find</code> is what the query will return. In this case whatever ends up being in <code>?name</code> comes out.</li><li>Each <code>:where</code> rule has a specific format, for our purposes for now its: <code>[&lt;entity-id> &lt;attribute> &lt;value>]</code>.</li><li>A variable in a rule is assigned any values that satisfies that rule. E.g. when we say <code>[?m :maker/name "BMW"]</code> the variable <code>?m</code> is at the <code>&lt;entity-id></code> position, so once this rule is processed, <code>?m</code> holds the entity-id for &ldquo;BMW&rdquo; maker.</li></ul><p>So as we go down the rules:</p><ul><li><code>[?m :maker/name "BMW"]</code> - <code>?m</code> ends up the entity-id of the &ldquo;BMW&rdquo; maker.</li><li><code>[?c :car/maker ?m]</code> - <code>?c</code> ends up with the entity-id of the car which has its maker as <code>?m</code> (which is &ldquo;BMW&rdquo;).</li><li><code>[?c :car/name ?name]</code> - <code>?name</code> ends up with the value of the <code>:car/name</code> attribute of the <code>?c</code> entity-id, which in this case is<code>"i525"</code>.</li><li>The rule processing finishes and we endup with <code>"i525"</code> in <code>?name</code> which is finally returned from the query.</li></ul><p>You could have also done this:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure>(<span style=color:#66d9ef>let </span>[car-entity (<span style=color:#a6e22e>ffirst</span>
                  (<span style=color:#a6e22e>d/q</span> <span style=color:#f92672>&#39;</span>[<span style=color:#e6db74>:find</span> ?c
                         <span style=color:#e6db74>:where</span>
                         [?e <span style=color:#e6db74>:maker/name</span> <span style=color:#e6db74>&#34;BMW&#34;</span>]
                         [?c <span style=color:#e6db74>:car/maker</span> ?e]]
                       <span style=color:#f92672>@</span>conn))]
  (<span style=color:#e6db74>:car/name</span> (<span style=color:#a6e22e>d/entity</span> <span style=color:#f92672>@</span>conn car-entity)))</code></pre></div></p><p>As far as I know there are better ways of doing things that I (and may be ?you) will eventually learn about.</p><h2 id=things-to-try>Things to try<a hidden class=anchor aria-hidden=true href=#things-to-try>#</a></h2><ul><li>Insert some more cars and makers.</li><li>What do you get from our query when a maker has multiple cars?</li></ul><h2 id=things-to-think-about>Things to think about<a hidden class=anchor aria-hidden=true href=#things-to-think-about>#</a></h2><ul><li>How do I get an entity-id if I want to insert a car later down the line and I&rsquo;ve already inserted the maker? In other words, how do I insert a car which is made by &ldquo;Honda&rdquo;? For now may be make two queries? First to get the entity-id for &ldquo;Honda&rdquo; followed by a transact to do the insertion?</li></ul><p>All of the stuff here is available <a href=https://gist.github.com/verma/1be6a0ddba850eb0da437968cd5994aa>as a gist here</a>{:target="_blank"}.</p><p>I will see you next time.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://udayv.com/>Uday Verma's Blog</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>